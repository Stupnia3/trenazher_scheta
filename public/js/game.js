function randomInteger(t,e){let s=t+Math.random()*(e+1-t);return Math.floor(s)}var historyGame=[];localStorage.setItem("historyGame","");let username=localStorage.getItem("username"),secret=localStorage.getItem("secret");username&&(document.querySelector("#username").value=username),secret&&(document.querySelector("#secret").value=secret);class Train{constructor(t){this.setting_container=t.setting_container,this.counter_container=t.counter_container,this.counter=1,this.start_training=t.start_training,this.number_container=t.number_container,this.tr_number=t.tr_number,this.result_container=t.result_container,this.statistic_container=t.statistic_container,this.result_form=t.result_form,this.imgs_container=document.querySelector(".training_imgs"),this.result_input=this.result_form.querySelector("input"),this.answer=null,this.stat_open=!1,this.img_path=t.img_path,this.stat_details=t.stat_details,this.details_button=this.statistic_container.querySelector(".training_button.details");let e=document.querySelectorAll(".restart");this.mode="normal",this.setting_container.addEventListener("click",t=>{t.preventDefault()}),this.details_button.addEventListener("click",()=>{this.stat_open=!this.stat_open,this.details_button.textContent=this.stat_open?"Скрыть":"Посмотреть",this.stat_details.style.display=this.stat_open?"flex":"none"}),this.mode_cont=this.setting_container.querySelector("#mode"),this.mode_cont.addEventListener("change",t=>{switch(this.mode=t.target.value,this.mode){case"flash":this.setting.rules.inputEl.closest(".training_setting").classList.add("disabled"),this.setting.action_count.inputEl.closest(".training_setting").classList.add("disabled"),this.setting.rules.value=5,this.setting.action_count.value=1;break;default:this.setting.rules.inputEl.closest(".training_setting").classList.remove("disabled"),this.setting.action_count.inputEl.closest(".training_setting").classList.remove("disabled"),this.setting.rules.value=parseInt(this.setting.rules.inputEl.value),this.setting.action_count.value=parseInt(this.setting.action_count.inputEl.value)}}),this.mode_cont.addEventListener("click",t=>{t.stopPropagation()}),e.forEach(t=>{t.addEventListener("click",()=>{this.restart()})}),this.result_input.addEventListener("input",t=>{null!=t.data&&(console.log(parseInt(t.data)),isNaN(parseInt(t.data))?this.result_input.value=this.result_input.value.slice(0,this.result_input.value.length-1):this.answer=this.result_input.value)}),this.result_form.addEventListener("submit",t=>{t.preventDefault(),this.answer&&this.checkAnswer()}),this.start_training.addEventListener("click",()=>{this.startingTraining()}),this.setting={bitness:{value:1,min:1,max:null,input:"selector",type:"int",inputEl:document.querySelector("#bitness")},rules:{value:1,min:1,max:null,input:"selector",type:"int",inputEl:document.querySelector("#rules")},action_count:{value:2,min:2,max:null,input:"input",type:"int",step:1,inputEl:document.querySelector("#action_count-input")},speed:{value:1,min:.4,max:4,step:.1,input:"input",type:"float",inputEl:document.querySelector("#speed-input")},examples:{value:1,min:1,max:null,input:"input",step:1,type:"int",inputEl:document.querySelector("#examples-input")}};for(let t in this.setting){let e="change";switch(this.setting[t].input){case"input":e="input",this.setting[t].plus=this.findEl(".plus",this.setting[t].inputEl),this.setting[t].minus=this.findEl(".minus",this.setting[t].inputEl)}this.setting[t].plus&&this.setting[t].plus.addEventListener("click",e=>{e.preventDefault(),this.changeSetting(t,this.setting[t].value+this.setting[t].step)}),this.setting[t].minus&&this.setting[t].minus.addEventListener("click",e=>{e.preventDefault(),this.changeSetting(t,this.setting[t].value-this.setting[t].step)}),this.setting[t].inputEl.addEventListener(e,e=>{if("float"==this.setting[t].type)switch(e.target.value){case"0,":return void(e.target.value="0.");case"0.":return}this.changeSetting(t,e.target.value)})}}restart(){this.result_container.style.display="none",this.statistic_container.style.display="none",this.setting_container.style.display="flex"}findEl(t,e){let s=e.parentNode,i=s.querySelector(t);return s!=document.body&&(null!=i?i:void this.findEl(t,s))}checkInput(t){t.value<=t.min?(t.value=t.min,t.minus.disabled=!0):t.minus.disabled=!1,null!=t.max&&t.value>=t.max?(t.value=t.max,t.plus.disabled=!0):t.plus.disabled=!1,t.inputEl.value=t.value}checkAnswer(){this.results.push({answer:this.answer,right:this.numbers_array[this.count].reduce((t,e)=>t+e,0),result:this.answer==this.numbers_array[this.count].reduce((t,e)=>t+e,0)});let t=this.results[this.count].result?".win":".fail";this.result_container.querySelector(".win").style.display="none",this.result_container.querySelector(".fail").style.display="none";let e=this.result_container.querySelectorAll(`${t} img`);this.result_container.querySelector(".wait").style.display="none";let s=1;e[0].parentNode.style.display="block",e[0].style.display="block";let i=setInterval(()=>{s<e.length?(e[s-1].style.display="none",e[s].style.display="block",s++):(e[s-1].style.display="none",e[0].style.display="block",s=1)},100),n=".win"==t?"#winaud":"#failaud";document.querySelector(n).play(),setTimeout(()=>{clearInterval(i),this.answer=null,this.result_input.value="",this.result_container.style.display="none",e.forEach(t=>{t.style.display="none"}),this.result_container.querySelector(".wait").style.display="block",this.count<this.setting.examples.value-1?(e[0].parentNode.style.display="block",this.startTraining(this.count+1)):this.showStatistic()},1e3)}showStatistic(){this.statistic_container.style.display="flex",this.statistic_container.querySelector(".training_details").style.display="none";let t=this.results.reduce((t,e)=>e.result?t+1:t,0),e=this.setting.examples.value-t;document.querySelector("#right").textContent=t,document.querySelector("#error").textContent=e;let s=document.querySelector("#template").content.querySelector(".training_details-item");this.stat_details.style.display="none",this.stat_details.querySelectorAll(".training_details-item").forEach(t=>{t.remove()}),this.details_button.textContent="Подробнее",this.stat_open=!1;let i={};switch(historyGame.res=[],historyGame.speed=this.setting.speed.value,"flash"==this.mode?historyGame.mode="Флешкарты":historyGame.mode="Обычный",this.setting.rules.value){case 1:historyGame.rule="Просто";break;case 2:historyGame.rule="Братья";break;case 3:historyGame.rule="Друзья";break;case 4:historyGame.rule="Анзан"}historyGame.capasity=this.setting.bitness.value,this.results.forEach((t,e)=>{(i={}).answer=t.answer,i.right=t.right,historyGame.res.push(i);let n=document.importNode(s,!0);n.querySelector(".ynumber").textContent=t.answer,t.result||n.querySelector(".ynumber").classList.add("error"),n.querySelector(".rnumber").textContent=t.right;let r="<table>";for(let t=0;t<this.setting.action_count.value;t+=8)r+="<tr>",this.numbers_array[e].slice(t,t+8).forEach(t=>{r+=`<td>${t}</td>`}),r+="</tr>";r+="</table>",n.querySelector(".digits").innerHTML=r,this.stat_details.appendChild(n)}),console.log(historyGame)}changeSetting(t,e){let s=this.setting[t];if(""!=e){switch(s.type){case"int":s.value=parseInt(e)?parseInt(e):s.min;break;case"float":if(0==parseFloat(e))return;s.value=parseFloat(e)?parseFloat(e):s.min,s.value=Math.round(10*s.value)/10}"input"==s.input&&this.checkInput(s)}}getAnswer(t){this.imgs_container.style.display="none",this.number_container.style.display="none",this.result_container.style.display="flex",this.result_input.focus()}showNumbers(t){t=t.toString();let e="";for(let s=0;s<t.length;s++)e+=`<img src="${this.img_path+t[s]}.svg" width="59" height="180" class="training_abakus">`;this.imgs_container.innerHTML=e}startTraining(t){switch(historyGame={},this.counter_container.style.display="none",this.result_container.querySelector(".win").style.display="none",this.result_container.querySelector(".fail").style.display="none",this.mode){case"flash":this.imgs_container.style.display="flex",this.showNumbers(this.numbers_array[t][0]);break;default:this.number_container.style.display="flex",this.tr_number.style.color="",this.tr_number.textContent=this.numbers_array[t][0]}this.curr_example=1,this.count=t,this.numInterval=setInterval(()=>{if(this.numbers_array[t].length>this.curr_example){switch(this.curr_example%2?this.tr_number.style.color="#000000":this.tr_number.style.color="",this.mode){case"flash":this.showNumbers(this.numbers_array[t][this.curr_example]);break;default:this.tr_number.textContent=this.numbers_array[t][this.curr_example]}this.curr_example++}else this.getAnswer(t),clearInterval(this.numInterval)},1e3*this.setting.speed.value)}startingTraining(){this.setting_container.style.display="none",this.counter_container.style.display="flex",this.counter_images=this.counter_container.querySelectorAll("img"),this.counter_images[2].style.display="block",document.querySelector("#tick").play(),this.results=[],this.answer=null,this.generateNumbers();document.querySelector("#tick");this.interval=setInterval(()=>{this.counter_images[this.counter+1].style.display="none",this.counter>=0?(this.counter_images[this.counter].style.display="block",this.counter--):(this.counter=1,this.startTraining(0),clearInterval(this.interval))},0)}getNumberWithoutRules(t,e=!1){t=Math.abs(t).toString();let s,i,n,r="";switch(parseInt(t[0])){case 1:case 5:s=!0;break;case 9:s=!1;break;default:s=!!Math.round(Math.random())}let a={0:[0,1,2,3,4,5,6,7,8,9],1:[0,1,2,3,5,6,7,8],2:[0,1,2,5,6,7],3:[0,1,5,6],4:[0,5],5:[0,1,2,3,4],6:[0,1,2,3],7:[0,1,2],8:[0,1],9:[0]},l={0:[0],1:[0,1],2:[0,1,2],3:[0,1,2,3],4:[0,1,2,3,4],5:[0,5],6:[0,1,5,6],7:[0,1,2,5,6,7],8:[0,1,2,3,5,6,7,8],9:[0,1,2,3,4,5,6,7,8,9]};s?n=(i=a)[t[0]].filter(t=>0!=t):(n=(i=l)[t[0]].filter(e=>![0,parseInt(t[0])].includes(e)),r="-"),r+=n[randomInteger(0,n.length-1)],e&&(parseInt(t[0])<5?(i=a,r=randomInteger(5-parseInt(t[0]),4)):(i=l,r="-"+randomInteger(parseInt(t[0])-4,4).toString()));for(let e=1;e<t.length;e++)r+=i[t[e]][randomInteger(0,i[t[e]].length-1)].toString();return parseInt(r)}generateNumbers(){this.numbers_array=[];for(let t=0;t<this.setting.examples.value;t++){let t=[],e=Math.pow(10,this.setting.bitness.value),s=Math.pow(10,this.setting.bitness.value-1);2==this.setting.rules.value&&(e-=s);let i=randomInteger(s,e-1);t.push(i);for(let s=1;s<this.setting.action_count.value;s++){let s=0;switch(this.setting.rules.value){case 1:s=this.getNumberWithoutRules(i);break;case 2:s=this.getNumberWithoutRules(i,!0);break;case 3:s=i<e?randomInteger(e-i,e-1):-randomInteger(i-e+1,e-1);break;case 4:let t=!!Math.round(Math.random());if(1==i&&(t=!0),t)s=randomInteger(1,e-1);else{s=-randomInteger(1,(e>i?i:e)-1)}}t.push(s),i+=s}this.numbers_array.push(t)}}}let train=new Train({setting_container:document.querySelector(".training_start"),counter_container:document.querySelector(".training_starting_counter"),start_training:document.querySelector(".training_button.start"),number_container:document.querySelector(".training_numbers"),tr_number:document.querySelector(".training_number"),result_container:document.querySelector(".training_result"),result_form:document.querySelector(".training_result-form"),statistic_container:document.querySelector(".training_statistic"),stat_details:document.querySelector(".training_details"),img_path:"/storage/img/"}),is_open=!1;function openPopup(t){(is_open=!is_open)?document.body.classList.add(t):document.body.classList=""}let form=document.querySelector("#popupform"),error=document.querySelector(".popup-form .error");form.addEventListener("submit",function(t){t.preventDefault(),localStorage.setItem("username",form.name.value),localStorage.setItem("secret",form.secret.value),error.style.display="none";let e=new FormData(form);e.append("hgame",JSON.stringify(historyGame));let s=new XMLHttpRequest;s.open("POST","/report.php"),s.send(e),s.onload=function(){if(200!=s.status)alert(`Ошибка ${s.status}: ${s.statusText}`);else{let t=s.response;"OK"==t?(openPopup(),openPopup("open_success"),historyGame={},error.style.display="none",error.textContent=""):(error.style.display="block",error.textContent="",error.textContent=t)}}});
